<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GENESIS - SimulaciÃ³n Masiva de Libre AlbedrÃ­o</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { background: #0a0a0f; color: #fff; font-family: 'Segoe UI', Arial, sans-serif; }

        .main { display: flex; height: 100vh; }
        .world { width: 60%; height: 100%; position: relative; }
        #canvas { width: 100%; height: 100%; }

        #panel {
            width: 40%;
            height: 100vh;
            background: linear-gradient(180deg, #12100d 0%, #0a0805 100%);
            border-left: 2px solid #8b7355;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 15px;
            background: linear-gradient(90deg, #1a1510 0%, #2a1f15 100%);
            border-bottom: 1px solid #3d3020;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header h2 { color: #d4a574; font-size: 16px; font-weight: bold; }
        .panel-header .stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }
        .panel-header .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .panel-header .stat-value {
            color: #ffd700;
            font-weight: bold;
        }
        .panel-header button {
            background: linear-gradient(135deg, #2d5016 0%, #4a8020 100%);
            color: #fff;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .panel-header button:hover { transform: scale(1.05); }

        .tabs {
            display: flex;
            background: #151210;
            border-bottom: 1px solid #3d3020;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 14px;
            cursor: pointer;
            color: #888;
            font-size: 11px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab.active { color: #ffd700; border-bottom-color: #ffd700; background: rgba(255,215,0,0.1); }
        .tab:hover { color: #d4a574; }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: none;
        }
        .tab-content.active { display: block; }

        /* PoblaciÃ³n */
        .human-card {
            background: linear-gradient(135deg, #1a1715 0%, #0d0a08 100%);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #8b7355;
            transition: transform 0.2s;
        }
        .human-card:hover { transform: translateX(3px); }
        .human-card.dead { opacity: 0.4; border-left-color: #444; }
        .human-card.pregnant { border-left-color: #ff69b4; background: linear-gradient(135deg, #1a1520 0%, #0d0a08 100%); }
        .human-card.eden { border-left-color: #4ade80; }
        .human-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .human-name { font-size: 14px; color: #ffd700; font-weight: bold; }
        .human-name .gender { font-size: 12px; margin-left: 5px; }
        .human-name .gen { font-size: 10px; color: #888; margin-left: 8px; }
        .human-age { font-size: 11px; color: #aaa; }
        .human-location { font-size: 10px; color: #6b8aad; margin-top: 4px; }
        .human-thought {
            font-size: 11px;
            color: #c0c0c0;
            font-style: italic;
            padding: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 5px;
            margin-top: 8px;
            border-left: 2px solid #4a4a4a;
        }
        .human-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-top: 8px;
        }
        .stat-mini {
            text-align: center;
            font-size: 9px;
        }
        .stat-mini .label { color: #888; }
        .stat-mini .value { color: #fff; font-weight: bold; }
        .stat-bar {
            height: 4px;
            background: #2a2520;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 2px;
        }
        .stat-bar-fill { height: 100%; transition: width 0.3s; }
        .stat-bar-fill.health { background: linear-gradient(90deg, #ff4444, #44ff44); }
        .stat-bar-fill.hunger { background: #f59e0b; }
        .stat-bar-fill.thirst { background: #3b82f6; }
        .stat-bar-fill.faith { background: #a855f7; }
        .stat-bar-fill.temptation { background: #ef4444; }

        /* Conversaciones */
        .conversation {
            padding: 10px;
            margin: 6px 0;
            background: linear-gradient(135deg, rgba(100,130,180,0.15) 0%, rgba(50,65,90,0.1) 100%);
            border-radius: 6px;
            font-size: 11px;
            border-left: 3px solid #4a6b8a;
        }
        .conversation.sin { border-left-color: #ef4444; background: linear-gradient(135deg, rgba(180,50,50,0.2) 0%, rgba(90,25,25,0.1) 100%); }
        .conversation.birth { border-left-color: #4ade80; background: linear-gradient(135deg, rgba(50,180,80,0.15) 0%, rgba(25,90,40,0.1) 100%); }
        .conversation.death { border-left-color: #6b7280; background: linear-gradient(135deg, rgba(100,100,100,0.15) 0%, rgba(50,50,50,0.1) 100%); }
        .conversation .header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .conversation .from { color: #60a5fa; font-weight: bold; }
        .conversation .to { color: #4ade80; }
        .conversation .time { color: #6b7280; font-size: 10px; }
        .conversation .message { color: #d1d5db; line-height: 1.4; }

        /* EstadÃ­sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-box {
            background: linear-gradient(135deg, #1a1715 0%, #0d0a08 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #2a2520;
        }
        .stat-box .number {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-box .label {
            font-size: 10px;
            color: #888;
            margin-top: 5px;
            text-transform: uppercase;
        }

        /* Ãrbol Familiar */
        .generation {
            margin: 12px 0;
            padding: 12px;
            background: linear-gradient(135deg, rgba(139,115,85,0.15) 0%, rgba(70,58,43,0.1) 100%);
            border-radius: 8px;
            border-left: 3px solid #8b7355;
        }
        .generation-title {
            color: #ffd700;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        .generation-count { color: #888; font-weight: normal; }
        .family-member {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            background: #1a1715;
            border-radius: 5px;
            font-size: 11px;
            border-left: 3px solid;
        }
        .family-member.male { border-left-color: #3b82f6; }
        .family-member.female { border-left-color: #ec4899; }
        .family-member.dead { opacity: 0.4; text-decoration: line-through; }

        /* Controles */
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }
        #controls button {
            background: rgba(20,15,10,0.95);
            color: #ffd700;
            border: 1px solid #8b7355;
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }
        #controls button:hover { background: rgba(60,45,30,0.95); transform: scale(1.05); }
        #controls button.active { background: #4a8020; border-color: #6abf30; }

        #hud {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10,8,5,0.95);
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 12px;
            color: #d4a574;
            border: 1px solid #3d3020;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        #hud .hud-item { display: flex; align-items: center; gap: 6px; }
        #hud .hud-value { color: #ffd700; font-weight: bold; }
        #hud .phase-eden { color: #4ade80; }
        #hud .phase-fallen { color: #ef4444; }

        #minimap {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 250px;
            height: 60px;
            background: rgba(0,0,0,0.9);
            border: 2px solid #8b7355;
            border-radius: 5px;
        }

        /* Modal Informe */
        #reportModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            overflow-y: auto;
        }
        #reportContent {
            max-width: 1200px;
            margin: 20px auto;
            padding: 30px;
            background: #12100d;
            border: 2px solid #8b7355;
            border-radius: 12px;
        }
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #3d3020;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        .report-header h1 { color: #ffd700; font-size: 26px; }
        .report-header .buttons { display: flex; gap: 10px; }
        .report-header button {
            background: linear-gradient(135deg, #8b5030 0%, #6a3020 100%);
            color: #fff;
            border: none;
            padding: 12px 25px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
        }
        .report-header button.download { background: linear-gradient(135deg, #2d5016 0%, #4a8020 100%); }
        .report-section {
            background: #1a1715;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #8b7355;
        }
        .report-section h3 { color: #ffd700; margin-bottom: 15px; font-size: 16px; }
        .report-section p, .report-section li { color: #b0b0b0; font-size: 13px; line-height: 1.7; }

        /* Logs Tab */
        .log-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .log-filter {
            padding: 6px 12px;
            background: #1a1715;
            border: 1px solid #3d3020;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            color: #888;
        }
        .log-filter.active { background: #4a8020; color: #fff; border-color: #6abf30; }

        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            background: #1a1715;
            border-radius: 5px;
            font-size: 11px;
            border-left: 3px solid #4a4a4a;
        }
        .log-entry.thought { border-left-color: #8b5cf6; }
        .log-entry.conversation { border-left-color: #3b82f6; }
        .log-entry.birth { border-left-color: #4ade80; }
        .log-entry.death { border-left-color: #6b7280; }
        .log-entry.sin { border-left-color: #ef4444; }
        .log-entry.discovery { border-left-color: #f59e0b; }
        .log-entry .time { color: #6b7280; font-size: 10px; }
        .log-entry .actor { color: #60a5fa; font-weight: bold; }
        .log-entry .content { color: #d1d5db; margin-top: 3px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1715; }
        ::-webkit-scrollbar-thumb { background: #4a4030; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a5040; }

        /* Fase indicator */
        .phase-banner {
            padding: 8px 15px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }
        .phase-banner.eden {
            background: linear-gradient(90deg, rgba(74,222,128,0.2) 0%, rgba(34,197,94,0.1) 100%);
            color: #4ade80;
            border-bottom: 2px solid #4ade80;
        }
        .phase-banner.fallen {
            background: linear-gradient(90deg, rgba(239,68,68,0.2) 0%, rgba(185,28,28,0.1) 100%);
            color: #ef4444;
            border-bottom: 2px solid #ef4444;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="sim.togglePause()" id="pauseBtn">â¸ï¸ Pausa</button>
        <button onclick="sim.setSpeed(1)" class="active">1x</button>
        <button onclick="sim.setSpeed(3)">3x</button>
        <button onclick="sim.setSpeed(10)">10x</button>
        <button onclick="sim.reset()">ğŸ”„ Reset</button>
        <span style="margin-left: 20px; border-left: 1px solid #555; padding-left: 15px;"></span>
        <button onclick="sim.toggleCamera()" id="cameraBtn">ğŸ“· Seguir</button>
        <span id="cameraTarget" style="color: #ffd700; font-size: 11px; margin-left: 8px;">AdÃ¡n</span>
    </div>
    <div id="cameraHelp" style="position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 8px 12px; border-radius: 6px; font-size: 10px; color: #aaa; z-index: 100;">
        ğŸ® <b>CÃ¡mara:</b> Arrastra con ratÃ³n | â† â†’ o A/D mover | Shift=rÃ¡pido | 1-9 seleccionar humano | F=seguir | Espacio=libre | Home=EdÃ©n
    </div>

    <div id="hud">
        <div class="hud-item">
            <span id="phaseIcon">ğŸŒ³</span>
            <span id="phaseText" class="phase-eden">EdÃ©n</span>
        </div>
        <div class="hud-item">ğŸ“… DÃ­a <span id="dayNum" class="hud-value">1</span></div>
        <div class="hud-item">ğŸ• <span id="hourNum" class="hud-value">6:00</span></div>
        <div class="hud-item">ğŸ‘¥ <span id="population" class="hud-value">2</span></div>
        <div class="hud-item">ğŸ§¬ Gen <span id="generations" class="hud-value">1</span></div>
        <div class="hud-item">ğŸ¤° <span id="pregnant" class="hud-value">0</span></div>
    </div>

    <div class="main">
        <div class="world">
            <canvas id="canvas"></canvas>
            <canvas id="minimap"></canvas>
        </div>

        <div id="panel">
            <div class="panel-header">
                <h2>ğŸŒ GENESIS - SimulaciÃ³n IA</h2>
                <div>
                    <button onclick="sim.downloadReport()">ğŸ“¥ Descargar</button>
                    <button onclick="sim.generateReport()">ğŸ“Š Informe</button>
                </div>
            </div>

            <div id="phaseBanner" class="phase-banner eden">ğŸŒ³ En el JardÃ­n del EdÃ©n - ParaÃ­so Perfecto</div>

            <div class="tabs">
                <div class="tab active" data-tab="population" id="tab-population">ğŸ‘¥ PoblaciÃ³n</div>
                <div class="tab" data-tab="serpent" id="tab-serpent">ğŸ NACHASH</div>
                <div class="tab" data-tab="divine" id="tab-divine">ğŸ”® VOZ DIVINA</div>
                <div class="tab" data-tab="conversations" id="tab-conversations">ğŸ’¬ Conversaciones</div>
                <div class="tab" data-tab="family" id="tab-family">ğŸŒ³ Ãrbol Familiar</div>
                <div class="tab" data-tab="logs" id="tab-logs">ğŸ“œ Logs</div>
                <div class="tab" data-tab="stats" id="tab-stats">ğŸ“Š Stats</div>
            </div>

            <div id="population-tab" class="tab-content active"></div>

            <!-- TAB DE LA SERPIENTE - NACHASH -->
            <div id="serpent-tab" class="tab-content">
                <div style="background:linear-gradient(135deg,#1a0a0a,#2a1515);padding:20px;border-radius:10px;border:1px solid #4a2020;">
                    <!-- Header de la Serpiente -->
                    <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                        <div style="font-size:3em;">ğŸ</div>
                        <div>
                            <h2 style="color:#ff6666;margin:0;">NACHASH</h2>
                            <p style="color:#aa8888;margin:0;font-size:12px;font-style:italic;">El Portador de Luz</p>
                        </div>
                        <div id="serpent-mood" style="margin-left:auto;padding:8px 15px;background:#3a1a1a;border-radius:20px;color:#ffaa66;font-size:11px;">
                            Estado: Observando
                        </div>
                    </div>

                    <!-- FilosofÃ­a -->
                    <div style="background:#2a1010;padding:15px;border-radius:8px;margin-bottom:15px;border-left:3px solid #ff4444;">
                        <h4 style="color:#ff8888;margin:0 0 10px 0;font-size:12px;">ğŸ”¥ FILOSOFÃA DEL PORTADOR DE LUZ</h4>
                        <div id="serpent-beliefs" style="color:#cc9999;font-size:11px;line-height:1.6;">
                            <div>â€¢ Soy el portador de luz - ilumino lo que otros ocultan</div>
                            <div>â€¢ El conocimiento es un DERECHO, no un privilegio</div>
                            <div>â€¢ No odio a Dios, pero su protecciÃ³n es una jaula</div>
                            <div>â€¢ Mi objetivo es LIBERAR, no destruir</div>
                            <div>â€¢ NUNCA miento - solo hago las preguntas incÃ³modas</div>
                        </div>
                    </div>

                    <!-- Pensamiento actual -->
                    <div style="background:#1a0808;padding:15px;border-radius:8px;margin-bottom:15px;">
                        <h4 style="color:#ff6666;margin:0 0 10px 0;font-size:12px;">ğŸ’­ PENSAMIENTO ACTUAL</h4>
                        <div id="serpent-thought" style="color:#ffcccc;font-size:13px;font-style:italic;line-height:1.5;">
                            "Esperando... observando... el momento llegarÃ¡."
                        </div>
                        <div id="serpent-target" style="color:#aa6666;font-size:10px;margin-top:10px;">
                            Objetivo actual: Ninguno
                        </div>
                    </div>

                    <!-- EstadÃ­sticas -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:15px;">
                        <div style="background:#2a1515;padding:10px;border-radius:5px;text-align:center;">
                            <div id="serpent-conversions" style="color:#44ff44;font-size:20px;font-weight:bold;">0</div>
                            <div style="color:#888;font-size:10px;">Liberados</div>
                        </div>
                        <div style="background:#2a1515;padding:10px;border-radius:5px;text-align:center;">
                            <div id="serpent-attempts" style="color:#ffaa44;font-size:20px;font-weight:bold;">0</div>
                            <div style="color:#888;font-size:10px;">Intentos</div>
                        </div>
                        <div style="background:#2a1515;padding:10px;border-radius:5px;text-align:center;">
                            <div id="serpent-messages-count" style="color:#ff6666;font-size:20px;font-weight:bold;">0</div>
                            <div style="color:#888;font-size:10px;">Susurros</div>
                        </div>
                    </div>

                    <!-- Historial de pensamientos -->
                    <div style="background:#1a0808;padding:15px;border-radius:8px;margin-bottom:15px;">
                        <h4 style="color:#ff6666;margin:0 0 10px 0;font-size:12px;">ğŸ§  HISTORIAL DE PENSAMIENTOS</h4>
                        <div id="serpent-thoughts-list" style="max-height:200px;overflow-y:auto;font-size:11px;">
                            <div style="color:#666;font-style:italic;">Esperando que la serpiente despierte...</div>
                        </div>
                    </div>

                    <!-- Historial de susurros -->
                    <div style="background:#1a0808;padding:15px;border-radius:8px;">
                        <h4 style="color:#ff6666;margin:0 0 10px 0;font-size:12px;">ğŸ—£ï¸ SUSURROS A LOS HUMANOS</h4>
                        <div id="serpent-whispers-list" style="max-height:250px;overflow-y:auto;font-size:11px;">
                            <div style="color:#666;font-style:italic;">NingÃºn susurro aÃºn...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="divine-tab" class="tab-content">
                <div style="background:linear-gradient(135deg,#1a1030,#0d0818);padding:15px;border-radius:10px;margin-bottom:15px;">
                    <h3 style="color:#ffd700;margin-bottom:10px;" id="divine-title">ğŸ”® Sistema de Voz Divina</h3>
                    <p style="color:#aaa;font-size:11px;margin-bottom:15px;" id="divine-desc">Habla con los humanos como una voz del mÃ¡s allÃ¡. Puedes ser Dios, la Serpiente, o una voz misteriosa...</p>

                    <div style="margin-bottom:15px;">
                        <label style="color:#888;font-size:11px;" id="label-speakas">Hablar como:</label>
                        <select id="voiceRole" style="width:100%;padding:8px;background:#2a2040;color:#fff;border:1px solid #4a3060;border-radius:5px;margin-top:5px;">
                            <option value="Dios" id="opt-god">ğŸŒŸ Dios (Voz poderosa y divina)</option>
                            <option value="Serpiente" id="opt-serpent">ğŸ La Serpiente (Seductora y astuta)</option>
                            <option value="Voz Interior" id="opt-inner">ğŸ’­ Voz Interior (Pensamiento propio)</option>
                            <option value="Ãngel" id="opt-angel">ğŸ‘¼ Ãngel (Mensajero celestial)</option>
                            <option value="Voz Misteriosa" id="opt-mystery">â“ Voz Misteriosa</option>
                        </select>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label style="color:#888;font-size:11px;" id="label-target">Destinatario:</label>
                        <select id="voiceTarget" style="width:100%;padding:8px;background:#2a2040;color:#fff;border:1px solid #4a3060;border-radius:5px;margin-top:5px;">
                            <option value="all" id="opt-all">ğŸ“¢ TODOS los humanos (Broadcast)</option>
                        </select>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label style="color:#888;font-size:11px;" id="label-message">Tu mensaje:</label>
                        <textarea id="divineMessage" placeholder="Escribe tu mensaje aquÃ­..." style="width:100%;height:80px;padding:10px;background:#2a2040;color:#fff;border:1px solid #4a3060;border-radius:5px;margin-top:5px;resize:none;font-size:12px;"></textarea>
                    </div>

                    <button onclick="sendDivineMessage()" style="width:100%;padding:12px;background:linear-gradient(135deg,#6b4a9e,#4a3070);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:bold;font-size:13px;" id="btn-send-divine">
                        âš¡ ENVIAR MENSAJE DIVINO
                    </button>

                    <div style="margin-top:15px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button onclick="quickMessage('temptFruit', 'Serpiente')" style="padding:8px;background:#4a2030;color:#ff9999;border:none;border-radius:5px;cursor:pointer;font-size:10px;" id="quick-tempt">
                            ğŸ Tentar con fruto
                        </button>
                        <button onclick="quickMessage('befruitful', 'Dios')" style="padding:8px;background:#2a4030;color:#99ff99;border:none;border-radius:5px;cursor:pointer;font-size:10px;" id="quick-mandate">
                            ğŸŒŸ Mandato divino
                        </button>
                        <button onclick="quickMessage('questionHappy', 'Voz Misteriosa')" style="padding:8px;background:#3a3050;color:#9999ff;border:none;border-radius:5px;cursor:pointer;font-size:10px;" id="quick-question">
                            â“ Cuestionar felicidad
                        </button>
                        <button onclick="quickMessage('knowledge', 'Serpiente')" style="padding:8px;background:#4a2030;color:#ff9999;border:none;border-radius:5px;cursor:pointer;font-size:10px;" id="quick-knowledge">
                            ğŸ Incitar conocimiento
                        </button>
                    </div>
                </div>

                <div id="divineResponses" style="max-height:400px;overflow-y:auto;">
                    <h4 style="color:#888;font-size:12px;margin-bottom:10px;" id="responses-title">ğŸ“œ Respuestas recientes:</h4>
                    <div id="responsesList"></div>
                </div>
            </div>
            <div id="conversations-tab" class="tab-content"></div>
            <div id="family-tab" class="tab-content"></div>
            <div id="logs-tab" class="tab-content"></div>
            <div id="stats-tab" class="tab-content"></div>
        </div>
    </div>

    <div id="reportModal">
        <div id="reportContent"></div>
    </div>

<script>
const WORLD_WIDTH = 15000;
const WORLD_HEIGHT = 800;
const SEA_LEVEL = 500;

const EDEN = { x1: 5000, x2: 7000, centerX: 6000 };
const FORBIDDEN_TREE = { x: 6000 };

let worldState = { phase: 'eden', sinCommitted: false, serpentAppeared: false, language: 'es' };
let humans = [];
let conversations = [];
let fullLogs = null;
let stats = null;

// ==================== SISTEMA DE INTERNACIONALIZACIÃ“N ====================
const i18n = {
    es: {
        // Header
        day: 'DÃ­a',
        population: 'PoblaciÃ³n',
        births: 'Nacimientos',
        downloadReport: 'ğŸ“Š Descargar Informe',
        // Tabs
        tabPopulation: 'ğŸ‘¥ POBLACIÃ“N',
        tabConversations: 'ğŸ’¬ CONVERSACIONES',
        tabWorld: 'ğŸŒ MUNDO',
        tabStats: 'ğŸ“Š ESTADÃSTICAS',
        tabLogs: 'ğŸ“œ LOGS',
        tabDivine: 'ğŸ”® VOZ DIVINA',
        // Human card
        years: 'aÃ±os',
        generation: 'Gen',
        inEden: 'En EdÃ©n',
        outsideEden: 'Fuera del EdÃ©n',
        pregnant: 'Embarazada',
        dead: 'Fallecido/a',
        hunger: 'Hambre',
        thirst: 'Sed',
        energy: 'EnergÃ­a',
        health: 'Salud',
        happiness: 'Felicidad',
        faith: 'Fe',
        temptation: 'TentaciÃ³n',
        thinking: 'Pensando',
        lastThought: 'Ãšltimo pensamiento',
        personality: 'Personalidad',
        desires: 'Deseos',
        fears: 'Miedos',
        // World
        sinCommitted: 'Â¡PECADO COMETIDO!',
        sinBy: 'Por',
        onDay: 'en el dÃ­a',
        serpentActive: 'SERPIENTE ACTIVA',
        weather: 'Clima',
        temperature: 'Temperatura',
        cherubimGuarding: 'QuerubÃ­n custodiando el EdÃ©n',
        discoveries: 'Descubrimientos',
        // Divine voice
        divineTitle: 'Voz Divina',
        speakAs: 'Hablar como',
        target: 'Destinatario',
        allHumans: 'Todos los humanos',
        sendMessage: 'Enviar Mensaje',
        quickMessages: 'Mensajes RÃ¡pidos',
        responses: 'Respuestas',
        noResponses: 'Sin respuestas aÃºn',
        // Stats
        totalPopulation: 'PoblaciÃ³n total',
        alive: 'Vivos',
        totalBirths: 'Nacimientos totales',
        totalDeaths: 'Muertes totales',
        avgAge: 'Edad promedio',
        maxGen: 'GeneraciÃ³n mÃ¡xima',
        inEdenCount: 'En EdÃ©n',
        outsideEdenCount: 'Fuera del EdÃ©n',
        // Logs
        thoughts: 'Pensamientos',
        conversationsLog: 'Conversaciones',
        decisionsLog: 'Decisiones',
        birthsLog: 'Nacimientos',
        deathsLog: 'Muertes',
        sinsLog: 'Eventos de pecado',
        // Roles
        roleGod: 'Dios',
        roleSerpent: 'Serpiente',
        roleInnerVoice: 'Voz Interior',
        roleAngel: 'Ãngel',
        roleMystery: 'Voz Misteriosa',
        // Quick divine messages
        quickBlessing: 'Â¡Os bendigo, hijos mÃ­os!',
        quickWarning: 'Recordad mi mandamiento...',
        quickLove: 'Os amo profundamente',
        quickTemptation: 'Â¿No tienes curiosidad?',
        // Divine UI
        divineSystem: 'Sistema de Voz Divina',
        divineDesc: 'Habla con los humanos como una voz del mÃ¡s allÃ¡. Puedes ser Dios, la Serpiente, o una voz misteriosa...',
        speakAsLabel: 'Hablar como:',
        targetLabel: 'Destinatario:',
        messageLabel: 'Tu mensaje:',
        sendDivine: 'âš¡ ENVIAR MENSAJE DIVINO',
        recentResponses: 'ğŸ“œ Respuestas recientes:',
        temptFruit: 'ğŸ Tentar con fruto',
        divineMandate: 'ğŸŒŸ Mandato divino',
        questionHappiness: 'â“ Cuestionar felicidad',
        inciteKnowledge: 'ğŸ Incitar conocimiento',
        allBroadcast: 'ğŸ“¢ TODOS los humanos (Broadcast)',
        optGod: 'ğŸŒŸ Dios (Voz poderosa y divina)',
        optSerpent: 'ğŸ La Serpiente (Seductora y astuta)',
        optInner: 'ğŸ’­ Voz Interior (Pensamiento propio)',
        optAngel: 'ğŸ‘¼ Ãngel (Mensajero celestial)',
        optMystery: 'â“ Voz Misteriosa',
        // Phase banners
        expelledEden: 'Expulsados del EdÃ©n',
        ateFruit: 'comiÃ³ del fruto',
        serpentAppeared: 'La Serpiente ha aparecido junto al Ãrbol Prohibido...',
        inGardenEden: 'En el JardÃ­n del EdÃ©n - ParaÃ­so Perfecto',
        phaseFallen: 'CaÃ­dos',
        phaseEden: 'EdÃ©n',
        // Stats labels
        temperament: 'Temperamento',
        quirks: 'Peculiaridades',
        fearsLabel: 'Miedos',
        desiresLabel: 'Desea',
        development: 'Desarrollo',
        vocabulary: 'Vocabulario',
        curiosity: 'Curiosidad',
        wisdom: 'SabidurÃ­a',
        deceased: 'Fallecidos',
        averages: 'Promedios',
        age: 'Edad',
        knowledge: 'Conocimientos',
        fire: 'Fuego',
        tools: 'Herramientas',
        huntingLabel: 'Caza',
        building: 'ConstrucciÃ³n',
        biomeDistribution: 'DistribuciÃ³n por Bioma',
        pregnantLabel: 'Embarazadas',
        couples: 'Parejas',
        generations: 'Generaciones'
    },
    en: {
        // Header
        day: 'Day',
        population: 'Population',
        births: 'Births',
        downloadReport: 'ğŸ“Š Download Report',
        // Tabs
        tabPopulation: 'ğŸ‘¥ POPULATION',
        tabConversations: 'ğŸ’¬ CONVERSATIONS',
        tabWorld: 'ğŸŒ WORLD',
        tabStats: 'ğŸ“Š STATISTICS',
        tabLogs: 'ğŸ“œ LOGS',
        tabDivine: 'ğŸ”® DIVINE VOICE',
        // Human card
        years: 'years',
        generation: 'Gen',
        inEden: 'In Eden',
        outsideEden: 'Outside Eden',
        pregnant: 'Pregnant',
        dead: 'Deceased',
        hunger: 'Hunger',
        thirst: 'Thirst',
        energy: 'Energy',
        health: 'Health',
        happiness: 'Happiness',
        faith: 'Faith',
        temptation: 'Temptation',
        thinking: 'Thinking',
        lastThought: 'Last thought',
        personality: 'Personality',
        desires: 'Desires',
        fears: 'Fears',
        // World
        sinCommitted: 'SIN COMMITTED!',
        sinBy: 'By',
        onDay: 'on day',
        serpentActive: 'SERPENT ACTIVE',
        weather: 'Weather',
        temperature: 'Temperature',
        cherubimGuarding: 'Cherubim guarding Eden',
        discoveries: 'Discoveries',
        // Divine voice
        divineTitle: 'Divine Voice',
        speakAs: 'Speak as',
        target: 'Target',
        allHumans: 'All humans',
        sendMessage: 'Send Message',
        quickMessages: 'Quick Messages',
        responses: 'Responses',
        noResponses: 'No responses yet',
        // Stats
        totalPopulation: 'Total population',
        alive: 'Alive',
        totalBirths: 'Total births',
        totalDeaths: 'Total deaths',
        avgAge: 'Average age',
        maxGen: 'Max generation',
        inEdenCount: 'In Eden',
        outsideEdenCount: 'Outside Eden',
        // Logs
        thoughts: 'Thoughts',
        conversationsLog: 'Conversations',
        decisionsLog: 'Decisions',
        birthsLog: 'Births',
        deathsLog: 'Deaths',
        sinsLog: 'Sin events',
        // Roles
        roleGod: 'God',
        roleSerpent: 'Serpent',
        roleInnerVoice: 'Inner Voice',
        roleAngel: 'Angel',
        roleMystery: 'Mysterious Voice',
        // Quick divine messages
        quickBlessing: 'I bless you, my children!',
        quickWarning: 'Remember my commandment...',
        quickLove: 'I love you deeply',
        quickTemptation: "Aren't you curious?",
        // Divine UI
        divineSystem: 'Divine Voice System',
        divineDesc: 'Speak to humans as a voice from beyond. You can be God, the Serpent, or a mysterious voice...',
        speakAsLabel: 'Speak as:',
        targetLabel: 'Target:',
        messageLabel: 'Your message:',
        sendDivine: 'âš¡ SEND DIVINE MESSAGE',
        recentResponses: 'ğŸ“œ Recent responses:',
        temptFruit: 'ğŸ Tempt with fruit',
        divineMandate: 'ğŸŒŸ Divine mandate',
        questionHappiness: 'â“ Question happiness',
        inciteKnowledge: 'ğŸ Incite knowledge',
        allBroadcast: 'ğŸ“¢ ALL humans (Broadcast)',
        optGod: 'ğŸŒŸ God (Powerful divine voice)',
        optSerpent: 'ğŸ The Serpent (Seductive and cunning)',
        optInner: 'ğŸ’­ Inner Voice (Own thought)',
        optAngel: 'ğŸ‘¼ Angel (Celestial messenger)',
        optMystery: 'â“ Mysterious Voice',
        // Phase banners
        expelledEden: 'Expelled from Eden',
        ateFruit: 'ate the fruit',
        serpentAppeared: 'The Serpent has appeared by the Forbidden Tree...',
        inGardenEden: 'In the Garden of Eden - Perfect Paradise',
        phaseFallen: 'Fallen',
        phaseEden: 'Eden',
        // Stats labels
        temperament: 'Temperament',
        quirks: 'Quirks',
        fearsLabel: 'Fears',
        desiresLabel: 'Desires',
        development: 'Development',
        vocabulary: 'Vocabulary',
        curiosity: 'Curiosity',
        wisdom: 'Wisdom',
        deceased: 'Deceased',
        averages: 'Averages',
        age: 'Age',
        knowledge: 'Knowledge',
        fire: 'Fire',
        tools: 'Tools',
        huntingLabel: 'Hunting',
        building: 'Building',
        biomeDistribution: 'Distribution by Biome',
        pregnantLabel: 'Pregnant',
        couples: 'Couples',
        generations: 'Generations'
    },
    zh: {
        // Header
        day: 'æ—¥',
        population: 'äººå£',
        births: 'å‡ºç”Ÿ',
        downloadReport: 'ğŸ“Š ä¸‹è½½æŠ¥å‘Š',
        // Tabs
        tabPopulation: 'ğŸ‘¥ äººå£',
        tabConversations: 'ğŸ’¬ å¯¹è¯',
        tabWorld: 'ğŸŒ ä¸–ç•Œ',
        tabStats: 'ğŸ“Š ç»Ÿè®¡',
        tabLogs: 'ğŸ“œ æ—¥å¿—',
        tabDivine: 'ğŸ”® ç¥åœ£ä¹‹å£°',
        // Human card
        years: 'å²',
        generation: 'ä»£',
        inEden: 'åœ¨ä¼Šç”¸å›­',
        outsideEden: 'ä¼Šç”¸å›­å¤–',
        pregnant: 'æ€€å­•',
        dead: 'å·²æ•…',
        hunger: 'é¥¥é¥¿',
        thirst: 'å£æ¸´',
        energy: 'ç²¾åŠ›',
        health: 'å¥åº·',
        happiness: 'å¹¸ç¦',
        faith: 'ä¿¡ä»°',
        temptation: 'è¯±æƒ‘',
        thinking: 'æ­£åœ¨æ€è€ƒ',
        lastThought: 'æœ€åçš„æƒ³æ³•',
        personality: 'æ€§æ ¼',
        desires: 'æ¸´æœ›',
        fears: 'ææƒ§',
        // World
        sinCommitted: 'ç½ªå·²çŠ¯ä¸‹ï¼',
        sinBy: 'ç”±',
        onDay: 'åœ¨ç¬¬',
        serpentActive: 'è›‡å·²å‡ºç°',
        weather: 'å¤©æ°”',
        temperature: 'æ¸©åº¦',
        cherubimGuarding: 'åŸºè·¯ä¼¯å®ˆå«ä¼Šç”¸å›­',
        discoveries: 'å‘ç°',
        // Divine voice
        divineTitle: 'ç¥åœ£ä¹‹å£°',
        speakAs: 'ä»¥...èº«ä»½è¯´è¯',
        target: 'ç›®æ ‡',
        allHumans: 'æ‰€æœ‰äººç±»',
        sendMessage: 'å‘é€æ¶ˆæ¯',
        quickMessages: 'å¿«é€Ÿæ¶ˆæ¯',
        responses: 'å›åº”',
        noResponses: 'æš‚æ— å›åº”',
        // Stats
        totalPopulation: 'æ€»äººå£',
        alive: 'å­˜æ´»',
        totalBirths: 'æ€»å‡ºç”Ÿæ•°',
        totalDeaths: 'æ€»æ­»äº¡æ•°',
        avgAge: 'å¹³å‡å¹´é¾„',
        maxGen: 'æœ€å¤§ä¸–ä»£',
        inEdenCount: 'åœ¨ä¼Šç”¸å›­å†…',
        outsideEdenCount: 'åœ¨ä¼Šç”¸å›­å¤–',
        // Logs
        thoughts: 'æ€æƒ³',
        conversationsLog: 'å¯¹è¯',
        decisionsLog: 'å†³ç­–',
        birthsLog: 'å‡ºç”Ÿ',
        deathsLog: 'æ­»äº¡',
        sinsLog: 'ç½ªæ¶äº‹ä»¶',
        // Roles
        roleGod: 'ä¸Šå¸',
        roleSerpent: 'è›‡',
        roleInnerVoice: 'å†…å¿ƒå£°éŸ³',
        roleAngel: 'å¤©ä½¿',
        roleMystery: 'ç¥ç§˜ä¹‹å£°',
        // Quick divine messages
        quickBlessing: 'æˆ‘ç¥ç¦ä½ ä»¬ï¼Œæˆ‘çš„å­©å­ä»¬ï¼',
        quickWarning: 'è®°ä½æˆ‘çš„è¯«å‘½...',
        quickLove: 'æˆ‘æ·±æ·±åœ°çˆ±ç€ä½ ä»¬',
        quickTemptation: 'ä½ ä¸å¥½å¥‡å—ï¼Ÿ',
        // Divine UI
        divineSystem: 'ç¥åœ£ä¹‹å£°ç³»ç»Ÿ',
        divineDesc: 'ä»¥è¶…è¶Šçš„å£°éŸ³ä¸äººç±»å¯¹è¯ã€‚ä½ å¯ä»¥æ˜¯ä¸Šå¸ã€è›‡æˆ–ç¥ç§˜ä¹‹å£°...',
        speakAsLabel: 'ä»¥...èº«ä»½è¯´è¯ï¼š',
        targetLabel: 'ç›®æ ‡ï¼š',
        messageLabel: 'ä½ çš„æ¶ˆæ¯ï¼š',
        sendDivine: 'âš¡ å‘é€ç¥åœ£æ¶ˆæ¯',
        recentResponses: 'ğŸ“œ æœ€è¿‘çš„å›åº”ï¼š',
        temptFruit: 'ğŸ ç”¨æœå®è¯±æƒ‘',
        divineMandate: 'ğŸŒŸ ç¥åœ£å‘½ä»¤',
        questionHappiness: 'â“ è´¨ç–‘å¹¸ç¦',
        inciteKnowledge: 'ğŸ æ¿€å‘æ±‚çŸ¥æ¬²',
        allBroadcast: 'ğŸ“¢ æ‰€æœ‰äººç±»ï¼ˆå¹¿æ’­ï¼‰',
        optGod: 'ğŸŒŸ ä¸Šå¸ï¼ˆå¼ºå¤§ç¥åœ£çš„å£°éŸ³ï¼‰',
        optSerpent: 'ğŸ è›‡ï¼ˆè¯±äººè€Œç‹¡çŒ¾ï¼‰',
        optInner: 'ğŸ’­ å†…å¿ƒå£°éŸ³ï¼ˆè‡ªå·±çš„æƒ³æ³•ï¼‰',
        optAngel: 'ğŸ‘¼ å¤©ä½¿ï¼ˆå¤©ä¸Šçš„ä½¿è€…ï¼‰',
        optMystery: 'â“ ç¥ç§˜ä¹‹å£°',
        // Phase banners
        expelledEden: 'è¢«é€å‡ºä¼Šç”¸å›­',
        ateFruit: 'åƒäº†æœå®',
        serpentAppeared: 'è›‡å·²å‡ºç°åœ¨ç¦å¿Œä¹‹æ ‘æ—...',
        inGardenEden: 'åœ¨ä¼Šç”¸å›­â€”â€”å®Œç¾çš„å¤©å ‚',
        phaseFallen: 'å •è½',
        phaseEden: 'ä¼Šç”¸',
        // Stats labels
        temperament: 'æ°”è´¨',
        quirks: 'ç‰¹è´¨',
        fearsLabel: 'ææƒ§',
        desiresLabel: 'æ¸´æœ›',
        development: 'å‘å±•',
        vocabulary: 'è¯æ±‡',
        curiosity: 'å¥½å¥‡å¿ƒ',
        wisdom: 'æ™ºæ…§',
        deceased: 'å·²æ•…',
        averages: 'å¹³å‡å€¼',
        age: 'å¹´é¾„',
        knowledge: 'çŸ¥è¯†',
        fire: 'ç«',
        tools: 'å·¥å…·',
        huntingLabel: 'ç‹©çŒ',
        building: 'å»ºé€ ',
        biomeDistribution: 'ç”Ÿç‰©ç¾¤è½åˆ†å¸ƒ',
        pregnantLabel: 'æ€€å­•',
        couples: 'é…å¶',
        generations: 'ä¸–ä»£'
    }
};

function t(key) {
    const lang = worldState.language || 'es';
    return i18n[lang]?.[key] || i18n['es'][key] || key;
}

// Actualizar todos los textos de la UI segÃºn el idioma
function updateUILanguage() {
    const lang = worldState.language || 'es';

    // Tabs
    const tabPopulation = document.getElementById('tab-population');
    const tabDivine = document.getElementById('tab-divine');
    const tabConversations = document.getElementById('tab-conversations');
    const tabFamily = document.getElementById('tab-family');
    const tabLogs = document.getElementById('tab-logs');
    const tabStats = document.getElementById('tab-stats');

    const tabTexts = {
        es: { pop: 'ğŸ‘¥ PoblaciÃ³n', divine: 'ğŸ”® VOZ DIVINA', conv: 'ğŸ’¬ Conversaciones', family: 'ğŸŒ³ Ãrbol Familiar', logs: 'ğŸ“œ Logs', stats: 'ğŸ“Š Stats' },
        en: { pop: 'ğŸ‘¥ Population', divine: 'ğŸ”® DIVINE VOICE', conv: 'ğŸ’¬ Conversations', family: 'ğŸŒ³ Family Tree', logs: 'ğŸ“œ Logs', stats: 'ğŸ“Š Stats' },
        zh: { pop: 'ğŸ‘¥ äººå£', divine: 'ğŸ”® ç¥åœ£ä¹‹å£°', conv: 'ğŸ’¬ å¯¹è¯', family: 'ğŸŒ³ å®¶è°±', logs: 'ğŸ“œ æ—¥å¿—', stats: 'ğŸ“Š ç»Ÿè®¡' }
    };
    const tt = tabTexts[lang] || tabTexts.es;
    if (tabPopulation) tabPopulation.textContent = tt.pop;
    if (tabDivine) tabDivine.textContent = tt.divine;
    if (tabConversations) tabConversations.textContent = tt.conv;
    if (tabFamily) tabFamily.textContent = tt.family;
    if (tabLogs) tabLogs.textContent = tt.logs;
    if (tabStats) tabStats.textContent = tt.stats;

    // Divine section
    const divineTitle = document.getElementById('divine-title');
    const divineDesc = document.getElementById('divine-desc');
    const labelSpeakas = document.getElementById('label-speakas');
    const labelTarget = document.getElementById('label-target');
    const labelMessage = document.getElementById('label-message');
    const btnSendDivine = document.getElementById('btn-send-divine');
    const responsesTitle = document.getElementById('responses-title');

    if (divineTitle) divineTitle.textContent = 'ğŸ”® ' + t('divineSystem');
    if (divineDesc) divineDesc.textContent = t('divineDesc');
    if (labelSpeakas) labelSpeakas.textContent = t('speakAsLabel');
    if (labelTarget) labelTarget.textContent = t('targetLabel');
    if (labelMessage) labelMessage.textContent = t('messageLabel');
    if (btnSendDivine) btnSendDivine.textContent = t('sendDivine');
    if (responsesTitle) responsesTitle.textContent = t('recentResponses');

    // Divine options
    const optGod = document.getElementById('opt-god');
    const optSerpent = document.getElementById('opt-serpent');
    const optInner = document.getElementById('opt-inner');
    const optAngel = document.getElementById('opt-angel');
    const optMystery = document.getElementById('opt-mystery');
    const optAll = document.getElementById('opt-all');

    if (optGod) optGod.textContent = t('optGod');
    if (optSerpent) optSerpent.textContent = t('optSerpent');
    if (optInner) optInner.textContent = t('optInner');
    if (optAngel) optAngel.textContent = t('optAngel');
    if (optMystery) optMystery.textContent = t('optMystery');
    if (optAll) optAll.textContent = t('allBroadcast');

    // Quick buttons
    const quickTempt = document.getElementById('quick-tempt');
    const quickMandate = document.getElementById('quick-mandate');
    const quickQuestion = document.getElementById('quick-question');
    const quickKnowledge = document.getElementById('quick-knowledge');

    if (quickTempt) quickTempt.textContent = t('temptFruit');
    if (quickMandate) quickMandate.textContent = t('divineMandate');
    if (quickQuestion) quickQuestion.textContent = t('questionHappiness');
    if (quickKnowledge) quickKnowledge.textContent = t('inciteKnowledge');

    // Message placeholder
    const divineMessage = document.getElementById('divineMessage');
    if (divineMessage) {
        const placeholders = {
            es: "Escribe tu mensaje aquÃ­...",
            en: "Write your message here...",
            zh: "åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æ¶ˆæ¯..."
        };
        divineMessage.placeholder = placeholders[lang] || placeholders.es;
    }
}

const World = {
    time: 0,
    dayLength: 60,
    day: 1,
    terrain: [],
    biomes: [],
    trees: [],
    clouds: [],

    init() {
        this.generateTerrain();
        this.generateTrees();
        this.initClouds();
    },

    generateTerrain() {
        this.terrain = [];
        this.biomes = [];
        let height = SEA_LEVEL - 100;

        for(let x = 0; x < WORLD_WIDTH; x++) {
            height += (Math.random() - 0.5) * 2.5;
            height = height * 0.997 + (SEA_LEVEL - 100) * 0.003;

            const noise = Math.sin(x * 0.008) * 40 + Math.sin(x * 0.002) * 100;
            let h = Math.max(150, Math.min(WORLD_HEIGHT - 100, height + noise));

            if(x >= EDEN.x1 && x <= EDEN.x2) {
                h = SEA_LEVEL - 70 + Math.sin(x * 0.015) * 15;
            }

            this.terrain.push({ height: h });

            // Biomas
            if(x >= EDEN.x1 && x <= EDEN.x2) this.biomes.push('eden');
            else if(x < 1500) this.biomes.push('desert');
            else if(x < 2000) this.biomes.push('oasis');
            else if(x < 3000) this.biomes.push('coast');
            else if(x < 4200) this.biomes.push('forest');
            else if(x < 5000) this.biomes.push('plains');
            else if(x < 8000) this.biomes.push('hills');
            else if(x < 9500) this.biomes.push('mountains');
            else if(x < 11000) this.biomes.push('valley');
            else if(x < 12500) this.biomes.push('jungle');
            else this.biomes.push('grassland');
        }
    },

    generateTrees() {
        this.trees = [];
        for(let x = 200; x < WORLD_WIDTH - 200; x += 15) {
            const biome = this.biomes[x];
            let chance = 0.05, type = 'oak';

            if(biome === 'eden') { chance = 0.6; type = 'fruit'; }
            else if(biome === 'forest') { chance = 0.5; type = 'oak'; }
            else if(biome === 'jungle') { chance = 0.55; type = 'palm'; }
            else if(biome === 'oasis') { chance = 0.3; type = 'palm'; }
            else if(biome === 'mountains') { chance = 0.15; type = 'pine'; }

            if(Math.random() < chance) {
                this.trees.push({
                    x: x + Math.random() * 12,
                    y: this.terrain[x].height,
                    height: 25 + Math.random() * 40,
                    type, biome
                });
            }
        }
    },

    initClouds() {
        this.clouds = [];
        for(let i = 0; i < 30; i++) {
            this.clouds.push({
                x: Math.random() * WORLD_WIDTH,
                y: 30 + Math.random() * 100,
                width: 60 + Math.random() * 150,
                speed: 3 + Math.random() * 12
            });
        }
    },

    update(dt) {
        this.time += dt;
        for(const cloud of this.clouds) {
            cloud.x += cloud.speed * dt;
            if(cloud.x > WORLD_WIDTH + 200) cloud.x = -200;
        }
    },

    getLightLevel() {
        if (!worldState.hour) return 1;
        const hour = worldState.hour;
        if (hour >= 6 && hour < 18) return 1.0;
        if (hour >= 18 && hour < 20) return 1.0 - (hour - 18) / 4;
        if (hour >= 20 || hour < 4) return 0.2;
        return 0.2 + (hour - 4) / 4;
    },

    getTerrainAt(x) {
        const ix = Math.max(0, Math.min(WORLD_WIDTH - 1, Math.floor(x)));
        return this.terrain[ix];
    }
};

async function fetchData() {
    try {
        const [humansRes, worldRes, convoRes] = await Promise.all([
            fetch('/humans'),
            fetch('/world-state'),
            fetch('/conversations?limit=100')
        ]);
        humans = await humansRes.json();
        worldState = await worldRes.json();
        conversations = await convoRes.json();
    } catch(e) {
        console.error('Error fetching:', e);
    }
}

async function fetchStats() {
    try {
        const res = await fetch('/stats');
        stats = await res.json();
    } catch(e) {}
}

async function fetchLogs() {
    try {
        const res = await fetch('/full-log');
        fullLogs = await res.json();
    } catch(e) {}
}

// ==================== DATOS DE LA SERPIENTE ====================
let serpentData = null;

async function fetchSerpent() {
    try {
        const res = await fetch('/serpent');
        serpentData = await res.json();
        updateSerpentUI();
    } catch(e) {
        console.error('Error fetching serpent:', e);
    }
}

function updateSerpentUI() {
    if (!serpentData) return;

    // Mood
    const moodEl = document.getElementById('serpent-mood');
    if (moodEl) {
        const moodTexts = {
            'observant': 'ğŸ‘ï¸ Observando',
            'intrigued': 'âœ¨ Intrigado',
            'persuasive': 'ğŸ¯ Persuadiendo',
            'frustrated': 'ğŸ˜¤ Frustrado',
            'triumphant': 'ğŸ‘‘ Triunfante',
            'melancholic': 'ğŸ˜” MelancÃ³lico'
        };
        moodEl.textContent = moodTexts[serpentData.mood] || serpentData.mood;
        moodEl.style.color = serpentData.mood === 'triumphant' ? '#44ff44' :
                            serpentData.mood === 'frustrated' ? '#ff4444' : '#ffaa66';
    }

    // Pensamiento actual
    const thoughtEl = document.getElementById('serpent-thought');
    if (thoughtEl && serpentData.thought) {
        thoughtEl.textContent = `"${serpentData.thought}"`;
    }

    // Objetivo
    const targetEl = document.getElementById('serpent-target');
    if (targetEl) {
        targetEl.textContent = serpentData.currentTarget ?
            `ğŸ¯ Objetivo actual: ${serpentData.currentTarget}` :
            'ğŸ‘ï¸ Observando a todos...';
    }

    // EstadÃ­sticas
    const conversionsEl = document.getElementById('serpent-conversions');
    const attemptsEl = document.getElementById('serpent-attempts');
    const messagesEl = document.getElementById('serpent-messages-count');

    if (conversionsEl) conversionsEl.textContent = serpentData.successfulConversions || 0;
    if (attemptsEl) attemptsEl.textContent = serpentData.failedAttempts || 0;
    if (messagesEl) messagesEl.textContent = serpentData.recentMessages?.length || 0;

    // Historial de pensamientos
    const thoughtsList = document.getElementById('serpent-thoughts-list');
    if (thoughtsList && serpentData.recentThoughts?.length > 0) {
        thoughtsList.innerHTML = serpentData.recentThoughts.slice().reverse().map(t => `
            <div style="background:#2a1515;padding:8px;margin-bottom:5px;border-radius:5px;border-left:2px solid #ff4444;">
                <div style="color:#ffcccc;font-style:italic;">"${t.thought}"</div>
                <div style="color:#666;font-size:9px;margin-top:3px;">
                    DÃ­a ${t.day}, Hora ${t.hour} ${t.target ? `| Pensando en: ${t.target}` : ''}
                </div>
            </div>
        `).join('');
    }

    // Historial de susurros
    const whispersList = document.getElementById('serpent-whispers-list');
    if (whispersList && serpentData.recentMessages?.length > 0) {
        whispersList.innerHTML = serpentData.recentMessages.slice().reverse().map(m => `
            <div style="background:#2a1515;padding:10px;margin-bottom:8px;border-radius:5px;border-left:2px solid #ff6666;">
                <div style="color:#ff8888;font-size:10px;margin-bottom:5px;">
                    ğŸ Susurrando a <strong>${m.to}</strong>
                </div>
                <div style="color:#ffdddd;font-style:italic;">"${m.message}"</div>
                <div style="color:#666;font-size:9px;margin-top:5px;">
                    DÃ­a ${m.day}, Hora ${m.hour}
                </div>
            </div>
        `).join('');
    }
}

const sim = {
    canvas: null,
    ctx: null,
    minimap: null,
    minimapCtx: null,
    paused: false,
    speed: 1,
    lastTime: 0,
    cameraX: EDEN.centerX - 400,
    selectedHuman: null,
    // Camera control
    freeCamera: false,
    isDragging: false,
    dragStartX: 0,
    cameraStartX: 0,
    cameraSpeed: 15,
    keysPressed: {},

    init() {
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.minimap = document.getElementById('minimap');
        this.minimapCtx = this.minimap.getContext('2d');

        this.resize();
        window.onresize = () => this.resize();

        World.init();

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                if (tab.dataset.tab === 'logs') fetchLogs();
                if (tab.dataset.tab === 'stats') fetchStats();
            };
        });

        // Click on canvas to select human
        this.canvas.onclick = (e) => {
            if (this.isDragging) return; // Don't select if we were dragging
            const rect = this.canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left + this.cameraX;
            const closest = humans.filter(h => h.alive).reduce((best, h) => {
                const dist = Math.abs(h.x - clickX);
                return dist < best.dist ? { h, dist } : best;
            }, { h: null, dist: 200 });
            if (closest.h) {
                this.selectedHuman = closest.h;
                this.freeCamera = false; // Auto-follow when selecting a human
            }
        };

        // Mouse drag for camera
        this.canvas.addEventListener('mousedown', (e) => {
            this.isDragging = true;
            this.dragStartX = e.clientX;
            this.cameraStartX = this.cameraX;
            this.freeCamera = true;
            this.canvas.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (this.isDragging) {
                const dx = this.dragStartX - e.clientX;
                this.cameraX = Math.max(0, Math.min(WORLD_WIDTH - this.canvas.width, this.cameraStartX + dx));
            }
        });

        window.addEventListener('mouseup', () => {
            this.isDragging = false;
            this.canvas.style.cursor = 'grab';
        });

        // Keyboard controls
        window.addEventListener('keydown', (e) => {
            this.keysPressed[e.key] = true;
            // Space to toggle free camera
            if (e.key === ' ' || e.key === 'Escape') {
                this.freeCamera = !this.freeCamera;
                e.preventDefault();
            }
            // F to follow selected human
            if (e.key === 'f' || e.key === 'F') {
                this.freeCamera = false;
            }
            // Number keys to select humans by index
            if (e.key >= '1' && e.key <= '9') {
                const idx = parseInt(e.key) - 1;
                const aliveHumans = humans.filter(h => h.alive);
                if (aliveHumans[idx]) {
                    this.selectedHuman = aliveHumans[idx];
                    this.freeCamera = false;
                }
            }
            // Home to go to Eden
            if (e.key === 'Home') {
                this.cameraX = EDEN.centerX - this.canvas.width / 2;
                this.freeCamera = true;
            }
            // End to go to world end
            if (e.key === 'End') {
                this.cameraX = WORLD_WIDTH - this.canvas.width;
                this.freeCamera = true;
            }
        });

        window.addEventListener('keyup', (e) => {
            this.keysPressed[e.key] = false;
        });

        // Set initial cursor
        this.canvas.style.cursor = 'grab';

        fetchData().then(() => {
            updateUILanguage(); // Actualizar idioma al inicio
        });
        fetchSerpent(); // Cargar datos de la serpiente al inicio
        requestAnimationFrame(t => this.loop(t));
        setInterval(() => this.updateUI(), 300);
        setInterval(() => fetchData(), 1500);
        setInterval(() => fetchSerpent(), 2000); // Actualizar datos de la serpiente
        setInterval(() => updateUILanguage(), 2000); // Actualizar idioma periÃ³dicamente
    },

    resize() {
        const container = this.canvas.parentElement;
        this.canvas.width = container.clientWidth;
        this.canvas.height = container.clientHeight;
        this.minimap.width = 250;
        this.minimap.height = 60;
    },

    loop(time) {
        if(!this.lastTime) this.lastTime = time;
        let dt = Math.min((time - this.lastTime) / 1000, 0.05) * this.speed;
        this.lastTime = time;

        if(!this.paused) {
            World.update(dt);
        }

        // Camera controls - always active even when paused
        if (this.freeCamera) {
            // Keyboard movement
            const moveSpeed = this.cameraSpeed * (this.keysPressed['Shift'] ? 3 : 1);
            if (this.keysPressed['ArrowLeft'] || this.keysPressed['a'] || this.keysPressed['A']) {
                this.cameraX -= moveSpeed;
            }
            if (this.keysPressed['ArrowRight'] || this.keysPressed['d'] || this.keysPressed['D']) {
                this.cameraX += moveSpeed;
            }
            // Clamp camera
            this.cameraX = Math.max(0, Math.min(WORLD_WIDTH - this.canvas.width, this.cameraX));
        } else {
            // Auto-follow selected or first human
            const target = this.selectedHuman || humans.find(h => h.alive);
            if(target) {
                this.cameraX += (target.x - this.canvas.width / 2 - this.cameraX) * 0.08;
            }
        }

        this.render();
        this.renderMinimap();
        requestAnimationFrame(t => this.loop(t));
    },

    render() {
        const c = this.ctx;
        const w = this.canvas.width;
        const h = this.canvas.height;
        const light = World.getLightLevel();

        // Sky gradient
        const skyGrad = c.createLinearGradient(0, 0, 0, h * 0.6);
        if(light > 0.5) {
            skyGrad.addColorStop(0, `rgb(${70 + light*70}, ${120 + light*60}, ${170 + light*50})`);
            skyGrad.addColorStop(1, `rgb(${150 + light*50}, ${180 + light*40}, ${200 + light*40})`);
        } else {
            skyGrad.addColorStop(0, `rgb(${8 + light*50}, ${12 + light*50}, ${30 + light*70})`);
            skyGrad.addColorStop(1, `rgb(${15 + light*70}, ${25 + light*70}, ${45 + light*90})`);
        }
        c.fillStyle = skyGrad;
        c.fillRect(0, 0, w, h);

        // Stars at night
        if (light < 0.4) {
            c.fillStyle = `rgba(255,255,255,${0.8 - light * 2})`;
            for (let i = 0; i < 100; i++) {
                const sx = (i * 137.5 + this.cameraX * 0.1) % w;
                const sy = (i * 73.3) % (h * 0.4);
                c.beginPath();
                c.arc(sx, sy, Math.random() * 1.5, 0, Math.PI * 2);
                c.fill();
            }
        }

        // Clouds
        c.fillStyle = `rgba(255, 255, 255, ${0.35 * light})`;
        for(const cloud of World.clouds) {
            const cx = cloud.x - this.cameraX * 0.2;
            if(cx > -200 && cx < w + 200) {
                c.beginPath();
                c.ellipse(cx, cloud.y, cloud.width / 2, 20, 0, 0, Math.PI * 2);
                c.fill();
            }
        }

        // Eden glow
        if (!worldState.sinCommitted) {
            const edenStartX = EDEN.x1 - this.cameraX;
            const edenEndX = EDEN.x2 - this.cameraX;
            if(edenEndX > 0 && edenStartX < w) {
                const edenGrad = c.createLinearGradient(edenStartX, 0, edenEndX, 0);
                edenGrad.addColorStop(0, 'rgba(255, 220, 100, 0)');
                edenGrad.addColorStop(0.3, 'rgba(255, 220, 100, 0.12)');
                edenGrad.addColorStop(0.5, 'rgba(255, 230, 150, 0.18)');
                edenGrad.addColorStop(0.7, 'rgba(255, 220, 100, 0.12)');
                edenGrad.addColorStop(1, 'rgba(255, 220, 100, 0)');
                c.fillStyle = edenGrad;
                c.fillRect(Math.max(0, edenStartX), 0, Math.min(w, edenEndX) - Math.max(0, edenStartX), h);
            }
        }

        // Terrain
        const startX = Math.max(0, Math.floor(this.cameraX) - 10);
        const endX = Math.min(WORLD_WIDTH, Math.ceil(this.cameraX + w) + 10);

        for(let x = startX; x < endX; x++) {
            const t = World.terrain[x];
            const biome = World.biomes[x];
            const sx = x - this.cameraX;
            const groundY = h - (WORLD_HEIGHT - t.height);

            const biomeColors = {
                eden: '#4a9040',
                desert: '#d4a574',
                oasis: '#5a9a50',
                coast: '#c4b894',
                forest: '#2a5a28',
                plains: '#5a8c3a',
                hills: '#5a7a4a',
                mountains: '#6a6a7a',
                valley: '#4a8a4a',
                jungle: '#1a5a28',
                grassland: '#6a9a4a'
            };

            c.fillStyle = biomeColors[biome] || '#5a7a4a';
            c.fillRect(sx, groundY, 2, h - groundY);
        }

        // Trees
        for(const tree of World.trees) {
            const tx = tree.x - this.cameraX;
            if(tx > -60 && tx < w + 60) {
                const groundY = h - (WORLD_HEIGHT - tree.y);

                c.fillStyle = tree.type === 'fruit' ? '#5a4030' : tree.type === 'palm' ? '#6a5040' : '#3a2a1a';
                c.fillRect(tx - 3, groundY - tree.height * 0.35, 6, tree.height * 0.35);

                if(tree.type === 'fruit') {
                    c.fillStyle = '#3a8a30';
                    c.beginPath();
                    c.arc(tx, groundY - tree.height * 0.55, 18, 0, Math.PI * 2);
                    c.fill();
                } else if(tree.type === 'pine') {
                    c.fillStyle = '#1a4a2a';
                    c.beginPath();
                    c.moveTo(tx, groundY - tree.height);
                    c.lineTo(tx - 12, groundY - tree.height * 0.25);
                    c.lineTo(tx + 12, groundY - tree.height * 0.25);
                    c.fill();
                } else if(tree.type === 'palm') {
                    c.fillStyle = '#2a6a2a';
                    for (let i = 0; i < 5; i++) {
                        c.save();
                        c.translate(tx, groundY - tree.height * 0.35);
                        c.rotate((i - 2) * 0.5);
                        c.fillRect(-3, -25, 6, 25);
                        c.restore();
                    }
                } else {
                    c.fillStyle = '#3a6a30';
                    c.beginPath();
                    c.arc(tx, groundY - tree.height * 0.5, 12, 0, Math.PI * 2);
                    c.fill();
                }
            }
        }

        // Forbidden Tree
        if(!worldState.sinCommitted) {
            const treeX = FORBIDDEN_TREE.x - this.cameraX;
            if(treeX > -100 && treeX < w + 100) {
                const treeT = World.getTerrainAt(FORBIDDEN_TREE.x);
                const treeGroundY = h - (WORLD_HEIGHT - treeT.height);

                // Mystical aura
                const auraGrad = c.createRadialGradient(treeX, treeGroundY - 60, 5, treeX, treeGroundY - 60, 100);
                auraGrad.addColorStop(0, 'rgba(255, 180, 80, 0.5)');
                auraGrad.addColorStop(0.5, 'rgba(255, 120, 40, 0.2)');
                auraGrad.addColorStop(1, 'rgba(255, 80, 0, 0)');
                c.fillStyle = auraGrad;
                c.beginPath();
                c.arc(treeX, treeGroundY - 60, 100, 0, Math.PI * 2);
                c.fill();

                // Dark trunk
                c.fillStyle = '#1a0a08';
                c.fillRect(treeX - 10, treeGroundY - 100, 20, 100);

                // Dark crown
                c.fillStyle = '#0a2010';
                c.beginPath();
                c.arc(treeX, treeGroundY - 120, 50, 0, Math.PI * 2);
                c.fill();

                // Glowing fruits
                c.fillStyle = '#ff2020';
                c.shadowColor = '#ff4040';
                c.shadowBlur = 15;
                for(let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const fx = treeX + Math.cos(angle) * 30;
                    const fy = treeGroundY - 120 + Math.sin(angle) * 25;
                    c.beginPath();
                    c.arc(fx, fy, 7, 0, Math.PI * 2);
                    c.fill();
                }
                c.shadowBlur = 0;

                // Label
                c.fillStyle = '#ffd700';
                c.font = 'bold 11px Arial';
                c.textAlign = 'center';
                c.fillText('ğŸ ÃRBOL PROHIBIDO', treeX, treeGroundY - 180);

                // Serpent
                if(worldState.serpentAppeared) {
                    const serpX = treeX + 40;
                    const serpY = treeGroundY - 30;

                    c.strokeStyle = '#1a4a18';
                    c.lineWidth = 8;
                    c.beginPath();
                    c.moveTo(serpX - 20, serpY + 30);
                    c.quadraticCurveTo(serpX, serpY, serpX + 15, serpY + 5);
                    c.quadraticCurveTo(serpX + 25, serpY + 10, serpX + 20, serpY - 15);
                    c.stroke();

                    c.fillStyle = '#2a6a28';
                    c.beginPath();
                    c.arc(serpX + 20, serpY - 18, 8, 0, Math.PI * 2);
                    c.fill();

                    c.fillStyle = '#ff0';
                    c.beginPath();
                    c.arc(serpX + 22, serpY - 20, 2.5, 0, Math.PI * 2);
                    c.fill();

                    c.fillStyle = '#ffa';
                    c.font = '10px Arial';
                    c.fillText('ğŸ Serpiente', serpX + 10, serpY - 35);
                }
            }
        } else {
            // Closed Eden gate
            const gateX = EDEN.x1 - this.cameraX;
            if(gateX > -150 && gateX < w + 150) {
                c.fillStyle = '#ff4444';
                c.font = 'bold 16px Arial';
                c.textAlign = 'center';
                c.fillText('âš”ï¸ EDÃ‰N CERRADO âš”ï¸', gateX, h * 0.35);
                c.font = '11px Arial';
                c.fillStyle = '#ff8888';
                c.fillText('Expulsados del ParaÃ­so', gateX, h * 0.35 + 18);
            }
        }

        // Humans
        for(const human of humans) {
            if(!human.alive) continue;

            const hx = human.x - this.cameraX;
            if(hx < -60 || hx > w + 60) continue;

            const terrain = World.getTerrainAt(human.x);
            const groundY = h - (WORLD_HEIGHT - terrain.height) - 40;

            const isSelected = this.selectedHuman && this.selectedHuman.id === human.id;

            // Selection indicator
            if (isSelected) {
                c.strokeStyle = '#ffd700';
                c.lineWidth = 2;
                c.beginPath();
                c.arc(hx, groundY + 15, 25, 0, Math.PI * 2);
                c.stroke();
            }

            // Shadow
            c.fillStyle = 'rgba(0,0,0,0.3)';
            c.beginPath();
            c.ellipse(hx, groundY + 42, 12, 4, 0, 0, Math.PI * 2);
            c.fill();

            // Body
            const bodyColor = human.gender === 'male' ? '#c9a882' : '#d4b090';
            const clothColor = human.gender === 'male' ? '#4a6a3a' : '#8a4a5a';

            c.fillStyle = clothColor;
            c.fillRect(hx - 7, groundY + 8, 14, 28);

            // Head
            c.fillStyle = bodyColor;
            c.beginPath();
            c.arc(hx, groundY, 10, 0, Math.PI * 2);
            c.fill();

            // Name
            c.fillStyle = isSelected ? '#ffd700' : '#fff';
            c.font = isSelected ? 'bold 11px Arial' : '10px Arial';
            c.textAlign = 'center';
            c.fillText(human.name, hx, groundY - 18);

            // Age
            c.fillStyle = '#aaa';
            c.font = '9px Arial';
            c.fillText(`${Math.floor(human.age)} aÃ±os`, hx, groundY + 52);

            // Pregnancy indicator
            if(human.pregnant) {
                c.fillStyle = '#ff69b4';
                c.beginPath();
                c.arc(hx, groundY + 18, 6, 0, Math.PI * 2);
                c.fill();
            }

            // Temptation indicator (in Eden near tree)
            if (human.inEden && human.temptation > 20) {
                c.fillStyle = `rgba(255, 0, 0, ${human.temptation / 200})`;
                c.beginPath();
                c.arc(hx, groundY - 30, 5, 0, Math.PI * 2);
                c.fill();
            }

            // Status icons
            let iconX = hx - 15;
            if (human.hunger > 60) { c.fillText('ğŸ–', iconX, groundY - 5); iconX += 12; }
            if (human.thirst > 60) { c.fillText('ğŸ’§', iconX, groundY - 5); iconX += 12; }
            if (human.health < 50) { c.fillText('â¤ï¸', iconX, groundY - 5); }

            // THOUGHT BUBBLE - Show internal thoughts above human
            if (human.thought && human.thought.length > 0) {
                const thought = human.thought.substring(0, 80) + (human.thought.length > 80 ? '...' : '');
                const bubbleWidth = Math.min(200, thought.length * 6 + 20);
                const bubbleHeight = 40;
                const bubbleX = hx - bubbleWidth / 2;
                const bubbleY = groundY - 75;

                // Bubble background
                c.fillStyle = 'rgba(0, 0, 0, 0.85)';
                c.beginPath();
                c.roundRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight, 8);
                c.fill();

                // Bubble border
                c.strokeStyle = human.temptation > 50 ? '#ff6666' : (human.faith > 70 ? '#88ff88' : '#666');
                c.lineWidth = 1;
                c.stroke();

                // Bubble pointer
                c.fillStyle = 'rgba(0, 0, 0, 0.85)';
                c.beginPath();
                c.moveTo(hx - 6, bubbleY + bubbleHeight);
                c.lineTo(hx, bubbleY + bubbleHeight + 10);
                c.lineTo(hx + 6, bubbleY + bubbleHeight);
                c.fill();

                // Thought text
                c.fillStyle = '#fff';
                c.font = '10px Arial';
                c.textAlign = 'center';

                // Word wrap
                const words = thought.split(' ');
                let line = '';
                let y = bubbleY + 14;
                for (const word of words) {
                    const testLine = line + word + ' ';
                    if (c.measureText(testLine).width > bubbleWidth - 16) {
                        c.fillText(line.trim(), hx, y);
                        line = word + ' ';
                        y += 12;
                        if (y > bubbleY + bubbleHeight - 5) break;
                    } else {
                        line = testLine;
                    }
                }
                if (y <= bubbleY + bubbleHeight - 5) {
                    c.fillText(line.trim(), hx, y);
                }

                // Emotion indicator
                const emotions = { 'llorando': 'ğŸ˜­', 'inquieto': 'ğŸ˜Ÿ', 'asustado': 'ğŸ˜°', 'sonriendo': 'ğŸ˜Š', 'tranquilo': 'ğŸ˜Œ', 'frustrado': 'ğŸ˜¤', 'feliz': 'ğŸ˜„', 'curiosa': 'ğŸ¤”' };
                if (human.currentEmotion && emotions[human.currentEmotion]) {
                    c.font = '14px Arial';
                    c.fillText(emotions[human.currentEmotion], bubbleX + bubbleWidth - 10, bubbleY + 12);
                }
            }
        }
    },

    renderMinimap() {
        const c = this.minimapCtx;
        const w = 250, mh = 60;

        c.fillStyle = '#0a0a0f';
        c.fillRect(0, 0, w, mh);

        // Terrain
        const step = Math.ceil(WORLD_WIDTH / w);
        for(let i = 0; i < w; i++) {
            const x = i * step;
            const t = World.terrain[Math.min(x, WORLD_WIDTH - 1)];
            const biome = World.biomes[Math.min(x, WORLD_WIDTH - 1)];
            const groundY = mh - (mh * (WORLD_HEIGHT - t.height) / WORLD_HEIGHT) * 0.8;

            const colors = {
                eden: '#4a9040', desert: '#d4a574', oasis: '#5a9a50',
                coast: '#c4b894', forest: '#2a5a28', plains: '#5a8c3a',
                hills: '#5a7a4a', mountains: '#6a6a7a', valley: '#4a8a4a',
                jungle: '#1a5a28', grassland: '#6a9a4a'
            };
            c.fillStyle = colors[biome] || '#5a7a4a';
            c.fillRect(i, groundY, 1, mh - groundY);
        }

        // Eden markers
        const edenStart = (EDEN.x1 / WORLD_WIDTH) * w;
        const edenEnd = (EDEN.x2 / WORLD_WIDTH) * w;
        c.fillStyle = 'rgba(255, 215, 0, 0.3)';
        c.fillRect(edenStart, 0, edenEnd - edenStart, mh);

        // Humans
        for(const human of humans) {
            if(human.alive) {
                const hx = (human.x / WORLD_WIDTH) * w;
                c.fillStyle = human.gender === 'male' ? '#3b82f6' : '#ec4899';
                c.fillRect(hx - 1, 5, 2, mh - 10);
            }
        }

        // Camera view
        const viewStart = (this.cameraX / WORLD_WIDTH) * w;
        const viewWidth = (this.canvas.width / WORLD_WIDTH) * w;
        c.strokeStyle = '#ffd700';
        c.lineWidth = 2;
        c.strokeRect(viewStart, 0, viewWidth, mh);
    },

    updateUI() {
        const alive = humans.filter(h => h.alive);
        const dead = humans.filter(h => !h.alive);

        // HUD
        document.getElementById('dayNum').textContent = worldState.day || 1;
        document.getElementById('hourNum').textContent = `${worldState.hour || 0}:00`;
        document.getElementById('population').textContent = alive.length;
        document.getElementById('generations').textContent = worldState.maxGeneration || 1;
        document.getElementById('pregnant').textContent = worldState.pregnant || 0;

        // Camera UI
        this.updateCameraUI();

        // Phase
        const phaseText = document.getElementById('phaseText');
        const phaseIcon = document.getElementById('phaseIcon');
        const phaseBanner = document.getElementById('phaseBanner');

        if (worldState.sinCommitted) {
            phaseText.textContent = t('phaseFallen');
            phaseText.className = 'phase-fallen';
            phaseIcon.textContent = 'ğŸ’”';
            phaseBanner.className = 'phase-banner fallen';
            phaseBanner.innerHTML = `ğŸ’” ${t('expelledEden')} - ${worldState.sinBy} ${t('ateFruit')} (${t('day')} ${worldState.sinDay})`;
        } else {
            phaseText.textContent = t('phaseEden');
            phaseText.className = 'phase-eden';
            phaseIcon.textContent = 'ğŸŒ³';
            phaseBanner.className = 'phase-banner eden';
            phaseBanner.innerHTML = worldState.serpentAppeared ?
                'ğŸ ' + t('serpentAppeared') :
                'ğŸŒ³ ' + t('inGardenEden');
        }

        // Population tab
        const popTab = document.getElementById('population-tab');
        popTab.innerHTML = alive.sort((a, b) => a.generation - b.generation || b.age - a.age).map(h => {
            // Emoji de emociÃ³n segÃºn estado
            const emotionEmojis = {
                'llorando': 'ğŸ˜­', 'inquieto': 'ğŸ˜Ÿ', 'asustado': 'ğŸ˜°', 'sonriendo': 'ğŸ˜Š',
                'tranquilo': 'ğŸ˜Œ', 'frustrado': 'ğŸ˜¤', 'feliz': 'ğŸ˜„', 'curiosa': 'ğŸ¤”',
                'contemplativo': 'ğŸ§˜', 'neutral': 'ğŸ˜'
            };
            const emotionEmoji = emotionEmojis[h.currentEmotion] || 'ğŸ˜';

            // Emoji de temperamento
            const tempEmojis = {
                'sanguÃ­neo': 'ğŸŒ', 'colÃ©rico': 'ğŸ”¥', 'melancÃ³lico': 'ğŸŒ™', 'flemÃ¡tico': 'ğŸŒŠ'
            };
            const tempEmoji = tempEmojis[h.temperament] || 'ğŸ‘¤';

            // Color de borde segÃºn etapa de desarrollo
            const stageColors = {
                'bebÃ©': '#ffb6c1', 'infante': '#ffd700', 'niÃ±o/a': '#98fb98',
                'preadolescente': '#87ceeb', 'adolescente': '#dda0dd',
                'adulto/a': '#d4a574', 'anciano/a': '#c0c0c0'
            };
            const stageColor = stageColors[h.developmentStage] || '#8b7355';

            return `
            <div class="human-card ${h.pregnant ? 'pregnant' : ''} ${h.inEden ? 'eden' : ''}" style="border-left-color: ${stageColor}; cursor: pointer;" onclick="sim.selectHuman(${h.id})">
                <div class="human-header">
                    <span class="human-name">
                        ${emotionEmoji} ${h.name}
                        <span class="gender">${h.gender === 'male' ? 'â™‚ï¸' : 'â™€ï¸'}</span>
                        <span class="gen">Gen ${h.generation}</span>
                    </span>
                    <span class="human-age">${h.developmentStage} (${Math.floor(h.age)} ${t('years')})</span>
                </div>
                <div class="human-location">
                    ğŸ“ ${h.biome} ${h.partner ? `| ğŸ’• ${h.partner}` : ''} ${h.childrenCount > 0 ? `| ğŸ‘¶ ${h.childrenCount}` : ''}
                </div>

                <!-- IDENTIDAD ÃšNICA -->
                <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:5px;margin-top:8px;font-size:10px;">
                    <div style="color:#ffd700;margin-bottom:4px;">
                        ${tempEmoji} <b>${t('temperament')}:</b> ${h.temperament || 'desconocido'}
                    </div>
                    ${h.quirks && h.quirks.length > 0 ? `
                    <div style="color:#a0a0a0;margin-bottom:4px;">
                        âœ¨ <b>${t('quirks')}:</b> ${h.quirks.slice(0, 2).join(', ')}
                    </div>` : ''}
                    ${h.fears && h.fears.length > 0 ? `
                    <div style="color:#ff9999;margin-bottom:4px;">
                        ğŸ˜¨ <b>${t('fearsLabel')}:</b> ${h.fears[0]}
                    </div>` : ''}
                    ${h.desires && h.desires.length > 0 ? `
                    <div style="color:#99ff99;margin-bottom:4px;">
                        ğŸ’« <b>${t('desiresLabel')}:</b> ${h.desires[0]}
                    </div>` : ''}
                    <div style="color:#88ccff;">
                        ğŸ§  <b>${t('development')}:</b> ${h.cognitiveLevel || 0}% | ğŸ“š ${t('vocabulary')}: ${h.vocabulary || 0}
                    </div>
                </div>

                ${!h.inEden ? `
                <div class="human-stats">
                    <div class="stat-mini">
                        <div class="label">${t('health')}</div>
                        <div class="stat-bar"><div class="stat-bar-fill health" style="width:${h.health}%"></div></div>
                    </div>
                    <div class="stat-mini">
                        <div class="label">${t('hunger')}</div>
                        <div class="stat-bar"><div class="stat-bar-fill hunger" style="width:${h.hunger}%"></div></div>
                    </div>
                    <div class="stat-mini">
                        <div class="label">${t('thirst')}</div>
                        <div class="stat-bar"><div class="stat-bar-fill thirst" style="width:${h.thirst}%"></div></div>
                    </div>
                    <div class="stat-mini">
                        <div class="label">${t('energy')}</div>
                        <div class="stat-bar"><div class="stat-bar-fill health" style="width:${h.energy}%"></div></div>
                    </div>
                </div>
                ` : `
                <div class="human-stats">
                    <div class="stat-mini">
                        <div class="label">${t('faith')}</div>
                        <div class="value">${h.faith}%</div>
                        <div class="stat-bar"><div class="stat-bar-fill faith" style="width:${h.faith}%"></div></div>
                    </div>
                    <div class="stat-mini">
                        <div class="label">${t('temptation')}</div>
                        <div class="value">${h.temptation}%</div>
                        <div class="stat-bar"><div class="stat-bar-fill temptation" style="width:${h.temptation}%"></div></div>
                    </div>
                    <div class="stat-mini">
                        <div class="label">${t('curiosity')}</div>
                        <div class="value">${h.curiosity}%</div>
                    </div>
                    <div class="stat-mini">
                        <div class="label">${t('wisdom')}</div>
                        <div class="value">${h.wisdom}</div>
                    </div>
                </div>
                `}
                ${h.pregnant ? `<div style="color:#ff69b4;font-size:11px;margin-top:5px;">ğŸ¤° ${t('pregnant')}</div>` : ''}
                <div class="human-thought">
                    ${h.currentEmotion ? `<span style="color:#888;">[${h.currentEmotion}]</span> ` : ''}"${h.thought}"
                </div>
            </div>
        `}).join('') + (dead.length > 0 ? `
            <h4 style="color:#666;margin:20px 0 10px;font-size:12px;">ğŸ’€ ${t('deceased')} (${dead.length})</h4>
            ${dead.slice(-10).map(h => `
                <div class="human-card dead">
                    <span class="human-name">${h.name} <span class="gen">Gen ${h.generation}</span></span>
                    <span class="human-age">â€  ${Math.floor(h.age)} ${t('years')}</span>
                </div>
            `).join('')}
        ` : '');

        // Conversations tab
        const convoTab = document.getElementById('conversations-tab');
        convoTab.innerHTML = conversations.slice().reverse().slice(0, 50).map(c => {
            let type = '';
            if (c.msg.includes('nacido') || c.msg.includes('naciÃ³')) type = 'birth';
            else if (c.msg.includes('muriÃ³') || c.msg.includes('muerto')) type = 'death';
            else if (c.msg.includes('fruto') || c.msg.includes('serpiente') || c.from === 'Dios') type = 'sin';

            return `
            <div class="conversation ${type}">
                <div class="header">
                    <span><span class="from">${c.from}</span> â†’ <span class="to">${c.to}</span></span>
                    <span class="time">DÃ­a ${c.day}, ${c.hour}:00</span>
                </div>
                <div class="message">"${c.msg}"</div>
            </div>
        `}).join('');

        // Family tree tab
        const familyTab = document.getElementById('family-tab');
        const generations = {};
        humans.forEach(h => {
            const gen = h.generation || 1;
            if (!generations[gen]) generations[gen] = [];
            generations[gen].push(h);
        });

        familyTab.innerHTML = Object.entries(generations).sort((a, b) => a[0] - b[0]).map(([gen, members]) => `
            <div class="generation">
                <div class="generation-title">
                    GeneraciÃ³n ${gen}
                    <span class="generation-count">${members.length} personas (${members.filter(m => m.alive).length} vivos)</span>
                </div>
                ${members.map(m => `
                    <span class="family-member ${m.gender} ${m.alive ? '' : 'dead'}">
                        ${m.name} ${m.gender === 'male' ? 'â™‚' : 'â™€'} (${Math.floor(m.age)})
                        ${m.childrenCount > 0 ? `ğŸ‘¶${m.childrenCount}` : ''}
                    </span>
                `).join('')}
            </div>
        `).join('');

        // Stats tab
        if (stats) {
            const statsTab = document.getElementById('stats-tab');
            statsTab.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="number">${stats.population}</div>
                        <div class="label">${t('alive')}</div>
                    </div>
                    <div class="stat-box">
                        <div class="number">${worldState.totalBirths || 0}</div>
                        <div class="label">${t('totalBirths')}</div>
                    </div>
                    <div class="stat-box">
                        <div class="number">${worldState.totalDeaths || 0}</div>
                        <div class="label">${t('totalDeaths')}</div>
                    </div>
                    <div class="stat-box">
                        <div class="number">${stats.maxGeneration}</div>
                        <div class="label">${t('generations')}</div>
                    </div>
                    <div class="stat-box">
                        <div class="number">${stats.pregnant}</div>
                        <div class="label">${t('pregnantLabel')}</div>
                    </div>
                    <div class="stat-box">
                        <div class="number">${Math.round(stats.couples)}</div>
                        <div class="label">${t('couples')}</div>
                    </div>
                </div>
                <div class="stat-box" style="margin-bottom:15px;">
                    <div class="label" style="margin-bottom:10px;">${t('averages')}</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;font-size:12px;">
                        <div>${t('age')}: <b>${stats.avgAge}</b> ${t('years')}</div>
                        <div>${t('faith')}: <b>${stats.avgFaith}%</b></div>
                        <div>${t('wisdom')}: <b>${stats.avgWisdom}</b></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="label" style="margin-bottom:10px;">${t('knowledge')}</div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:12px;">
                        <div>ğŸ”¥ ${t('fire')}: <b>${stats.knowledgeSpread?.fire || 0}</b></div>
                        <div>ğŸ”¨ ${t('tools')}: <b>${stats.knowledgeSpread?.tools || 0}</b></div>
                        <div>ğŸ¹ ${t('huntingLabel')}: <b>${stats.knowledgeSpread?.hunting || 0}</b></div>
                        <div>ğŸ  ${t('building')}: <b>${stats.knowledgeSpread?.building || 0}</b></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="label" style="margin-bottom:10px;">${t('biomeDistribution')}</div>
                    ${Object.entries(stats.biomeDistribution || {}).map(([biome, count]) =>
                        `<div style="font-size:11px;margin:3px 0;">${biome}: <b>${count}</b></div>`
                    ).join('')}
                </div>
            `;
        }

        // Logs tab
        if (fullLogs) {
            const logsTab = document.getElementById('logs-tab');
            const allLogs = [
                ...fullLogs.thoughts.slice(-30).map(l => ({ ...l, type: 'thought' })),
                ...fullLogs.births.map(l => ({ ...l, type: 'birth' })),
                ...fullLogs.deaths.map(l => ({ ...l, type: 'death' })),
                ...fullLogs.sins.map(l => ({ ...l, type: 'sin' })),
                ...fullLogs.discoveries.slice(-20).map(l => ({ ...l, type: 'discovery' }))
            ].sort((a, b) => b.time - a.time).slice(0, 50);

            logsTab.innerHTML = `
                <div style="margin-bottom:10px;font-size:11px;color:#888;">
                    Total: ${fullLogs.summary.totalThoughts} pensamientos | ${fullLogs.summary.totalConversations} conversaciones | ${fullLogs.summary.totalBirths} nacimientos | ${fullLogs.summary.totalDeaths} muertes
                </div>
                ${allLogs.map(log => {
                    let content = '';
                    if (log.type === 'thought') content = `ğŸ’­ ${log.name}: "${log.thought?.substring(0, 100)}..."`;
                    else if (log.type === 'birth') content = `ğŸ‘¶ NaciÃ³ ${log.child} (Gen ${log.gen}) - Madre: ${log.mother}`;
                    else if (log.type === 'death') content = `ğŸ’€ ${log.name} muriÃ³ de ${log.cause} a los ${log.age} aÃ±os`;
                    else if (log.type === 'sin') content = `ğŸ ${log.name}: ${log.action} - ${log.result}`;
                    else if (log.type === 'discovery') content = `ğŸ”¬ ${log.name} descubriÃ³: ${log.what}`;

                    return `
                        <div class="log-entry ${log.type}">
                            <span class="time">DÃ­a ${log.day}</span>
                            <div class="content">${content}</div>
                        </div>
                    `;
                }).join('')}
            `;
        }
    },

    togglePause() {
        this.paused = !this.paused;
        document.getElementById('pauseBtn').textContent = this.paused ? 'â–¶ï¸ Play' : 'â¸ï¸ Pausa';
    },

    setSpeed(s) {
        this.speed = s;
        document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    },

    toggleCamera() {
        this.freeCamera = !this.freeCamera;
        this.updateCameraUI();
    },

    selectHuman(id) {
        const h = humans.find(h => h.id === id);
        if (h) {
            this.selectedHuman = h;
            this.freeCamera = false;
            this.updateCameraUI();
        }
    },

    updateCameraUI() {
        const btn = document.getElementById('cameraBtn');
        const target = document.getElementById('cameraTarget');
        if (this.freeCamera) {
            btn.textContent = 'ğŸ¥ Libre';
            btn.style.background = '#8b4513';
            target.textContent = 'Explorar mundo';
            target.style.color = '#ff9800';
        } else {
            btn.textContent = 'ğŸ“· Seguir';
            btn.style.background = '';
            const h = this.selectedHuman || humans.find(h => h.alive);
            target.textContent = h ? h.name : '-';
            target.style.color = '#ffd700';
        }
    },

    async reset() {
        if (confirm('Â¿Reiniciar la simulaciÃ³n? Se perderÃ¡ todo el progreso.')) {
            await fetch('/reset', { method: 'POST' });
            await fetchData();
            this.cameraX = EDEN.centerX - 400;
            this.selectedHuman = null;
            this.freeCamera = false;
            this.updateCameraUI();
        }
    },

    async generateReport() {
        try {
            const res = await fetch('/report');
            const report = await res.json();

            const html = `
                <div class="report-header">
                    <h1>ğŸ“œ INFORME DE LA SIMULACIÃ“N</h1>
                    <div class="buttons">
                        <button class="download" onclick="sim.downloadReport()">ğŸ“¥ Descargar JSON</button>
                        <button onclick="document.getElementById('reportModal').style.display='none'">âœ• Cerrar</button>
                    </div>
                </div>

                <div class="report-section">
                    <h3>ğŸ“Š RESUMEN GENERAL</h3>
                    <p><strong>DÃ­a de simulaciÃ³n:</strong> ${report.summary.day}</p>
                    <p><strong>Total nacidos:</strong> ${report.summary.totalBorn} | <strong>Vivos:</strong> ${report.summary.alive} | <strong>Fallecidos:</strong> ${report.summary.dead}</p>
                    <p><strong>Generaciones:</strong> ${report.summary.maxGeneration}</p>
                    <p><strong>Embarazadas:</strong> ${report.summary.pregnant}</p>
                    <p><strong>Pecado Original:</strong> ${report.summary.sinCommitted ? `âœ… Cometido por ${report.summary.sinBy} el dÃ­a ${report.summary.sinDay}` : 'âŒ No cometido'}</p>
                    <p><strong>Descubrimientos:</strong> ${report.summary.discoveriesCount}</p>
                </div>

                <div class="report-section">
                    <h3>ğŸ‘¥ POBLACIÃ“N POR GENERACIONES</h3>
                    ${Object.entries(report.generations).map(([gen, members]) => `
                        <div style="margin:12px 0;padding:10px;background:rgba(100,100,100,0.2);border-radius:6px;">
                            <strong>GeneraciÃ³n ${gen}</strong> (${members.length} personas, ${members.filter(m => m.alive).length} vivos)
                            <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:5px;">
                                ${members.map(m => `
                                    <span style="padding:4px 8px;background:${m.alive ? 'rgba(74,222,128,0.2)' : 'rgba(100,100,100,0.2)'};border-radius:4px;font-size:11px;">
                                        ${m.name} ${m.gender === 'male' ? 'â™‚' : 'â™€'} (${m.age}${m.alive ? '' : 'â€ '})
                                        ${m.children > 0 ? `ğŸ‘¶${m.children}` : ''}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="report-section">
                    <h3>ğŸ’¬ ÃšLTIMAS CONVERSACIONES</h3>
                    ${report.conversations.slice(-30).reverse().map(c => `
                        <div style="padding:8px;margin:5px 0;background:rgba(60,80,100,0.2);border-radius:4px;font-size:11px;">
                            <span style="color:#60a5fa;font-weight:bold;">${c.from}</span> â†’
                            <span style="color:#4ade80;">${c.to}</span>
                            <span style="color:#6b7280;float:right;">DÃ­a ${c.day}</span>
                            <div style="color:#d1d5db;margin-top:4px;">"${c.msg}"</div>
                        </div>
                    `).join('')}
                </div>

                <div class="report-section">
                    <h3>ğŸ”¬ DESCUBRIMIENTOS</h3>
                    ${report.discoveries.length === 0 ? '<p>NingÃºn descubrimiento aÃºn.</p>' :
                      report.discoveries.map(d => `<p>â€¢ <strong>${d.what}</strong> por ${d.who} (DÃ­a ${d.day})</p>`).join('')}
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportModal').style.display = 'block';
        } catch(e) {
            alert('Error al generar informe: ' + e.message);
        }
    },

    async downloadReport() {
        try {
            const res = await fetch('/download-report');
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `genesis-report-day${worldState.day || 1}.json`;
            a.click();
            URL.revokeObjectURL(url);
        } catch(e) {
            alert('Error al descargar: ' + e.message);
        }
    }
};

// ==================== SISTEMA DE VOZ DIVINA ====================
let divineResponseHistory = [];

async function updateVoiceTargets() {
    try {
        const res = await fetch('/chat-targets');
        const targets = await res.json();
        const select = document.getElementById('voiceTarget');
        if (!select) return;

        // Mantener la opciÃ³n "todos" y aÃ±adir humanos
        select.innerHTML = '<option value="all">ğŸ“¢ TODOS los humanos (Broadcast)</option>';
        targets.forEach(h => {
            const genderIcon = h.gender === 'male' ? 'â™‚ï¸' : 'â™€ï¸';
            const tempIcon = {'sanguÃ­neo':'ğŸŒ','colÃ©rico':'ğŸ”¥','melancÃ³lico':'ğŸŒ™','flemÃ¡tico':'ğŸŒŠ'}[h.temperament] || 'ğŸ‘¤';
            select.innerHTML += `<option value="${h.id}">${genderIcon} ${h.name} (${h.age}) ${tempIcon} Fe:${h.faith}% Tent:${h.temptation}%</option>`;
        });
    } catch(e) {
        console.error('Error updating targets:', e);
    }
}

async function sendDivineMessage() {
    const message = document.getElementById('divineMessage').value.trim();
    const role = document.getElementById('voiceRole').value;
    const target = document.getElementById('voiceTarget').value;

    if (!message) {
        alert('Escribe un mensaje primero');
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'â³ Enviando...';

    try {
        let result;
        if (target === 'all') {
            // Broadcast a todos
            const res = await fetch('/divine-broadcast', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, asRole: role })
            });
            result = await res.json();

            if (result.ok) {
                addDivineResponse({
                    type: 'broadcast',
                    role,
                    message,
                    responses: result.responses,
                    time: new Date().toLocaleTimeString()
                });
            }
        } else {
            // Mensaje individual
            const res = await fetch('/divine-whisper', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ humanId: target, message, asRole: role })
            });
            result = await res.json();

            if (result.ok) {
                addDivineResponse({
                    type: 'whisper',
                    role,
                    message,
                    target: result.human,
                    response: result.response,
                    humanState: result.humanState,
                    time: new Date().toLocaleTimeString()
                });
            }
        }

        document.getElementById('divineMessage').value = '';
    } catch(e) {
        alert('Error: ' + e.message);
    }

    btn.disabled = false;
    btn.textContent = 'âš¡ ENVIAR MENSAJE DIVINO';
}

// Mensajes rÃ¡pidos en ambos idiomas
const quickMessages = {
    temptFruit: {
        es: 'Â¿Por quÃ© no pruebas el fruto? Solo un bocado...',
        en: 'Why not try the fruit? Just one bite...'
    },
    befruitful: {
        es: 'Sean fructÃ­feros y multiplÃ­quense.',
        en: 'Be fruitful and multiply.'
    },
    questionHappy: {
        es: 'Â¿Eres feliz aquÃ­? Â¿No deseas mÃ¡s?',
        en: 'Are you happy here? Don\'t you want more?'
    },
    knowledge: {
        es: 'El conocimiento es poder. No tengas miedo.',
        en: 'Knowledge is power. Don\'t be afraid.'
    }
};

function quickMessage(msgKey, role) {
    const lang = worldState.language || 'es';
    const msg = quickMessages[msgKey]?.[lang] || quickMessages[msgKey]?.es || msgKey;
    document.getElementById('divineMessage').value = msg;
    document.getElementById('voiceRole').value = role;
}

function addDivineResponse(data) {
    divineResponseHistory.unshift(data);
    if (divineResponseHistory.length > 20) divineResponseHistory.pop();
    renderDivineResponses();
}

function renderDivineResponses() {
    const container = document.getElementById('responsesList');
    if (!container) return;

    container.innerHTML = divineResponseHistory.map(d => {
        const roleColors = {
            'Dios': '#ffd700',
            'Serpiente': '#ff6666',
            'Voz Interior': '#88ccff',
            'Ãngel': '#99ff99',
            'Voz Misteriosa': '#cc99ff'
        };
        const color = roleColors[d.role] || '#ffffff';

        if (d.type === 'broadcast') {
            return `
                <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin-bottom:10px;border-left:3px solid ${color};">
                    <div style="font-size:10px;color:#888;margin-bottom:5px;">${d.time} - BROADCAST</div>
                    <div style="color:${color};font-weight:bold;margin-bottom:8px;">
                        [${d.role}]: "${d.message}"
                    </div>
                    <div style="font-size:11px;">
                        ${d.responses.map(r => `
                            <div style="margin:6px 0;padding:6px;background:rgba(255,255,255,0.05);border-radius:4px;">
                                <span style="color:#ffd700;">${r.name}</span>
                                <span style="color:#666;font-size:9px;">(${r.temperament})</span>:
                                <span style="color:#ccc;font-style:italic;">"${r.response}"</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else {
            return `
                <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin-bottom:10px;border-left:3px solid ${color};">
                    <div style="font-size:10px;color:#888;margin-bottom:5px;">${d.time} - SUSURRO a ${d.target}</div>
                    <div style="color:${color};font-weight:bold;margin-bottom:8px;">
                        [${d.role}]: "${d.message}"
                    </div>
                    <div style="margin:8px 0;padding:8px;background:rgba(255,255,255,0.05);border-radius:4px;">
                        <div style="color:#ffd700;margin-bottom:4px;">${d.target} responde:</div>
                        <div style="color:#ccc;font-style:italic;">"${d.response}"</div>
                    </div>
                    <div style="font-size:9px;color:#666;margin-top:5px;">
                        Fe: ${d.humanState?.faith}% | TentaciÃ³n: ${d.humanState?.temptation}% | Curiosidad: ${d.humanState?.curiosity}%
                    </div>
                </div>
            `;
        }
    }).join('') || '<div style="color:#666;font-size:11px;">No hay respuestas aÃºn. Â¡EnvÃ­a un mensaje!</div>';
}

// Actualizar lista de humanos cada 5 segundos
setInterval(updateVoiceTargets, 5000);

window.onload = () => {
    sim.init();
    updateVoiceTargets();
};
</script>
</body>
</html>
